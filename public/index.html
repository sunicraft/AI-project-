<script>
    // *** AI BACKEND URL ***
    const BACKEND_URL = "https://ai-project-14h7.onrender.com/api/analyze-and-generate";

    // ✅ GLOBAL STATE (IMPORTANT FIX)
    let aiDescriptionSnippet = "";

    // --- CORE FUNCTION: RUN ANALYSIS ---
    async function runAnalysis() {
        const input = document.getElementById("inputTitle").value.trim();
        const resultsContainer = document.getElementById("titles-results");
        const analyzeButton = document.querySelector('button[onclick="runAnalysis()"]');

        if (!input) {
            alert("Please enter a topic first!");
            return;
        }

        analyzeButton.disabled = true;
        analyzeButton.textContent = "Analyzing...";

        resultsContainer.innerHTML = `<div style="text-align:center;color:#66FCF1;">
            <i class="fas fa-spinner fa-spin"></i> Generating AI results...
        </div>`;

        document.getElementById("keyword-results").innerHTML = `<p style="text-align:center;">Processing...</p>`;
        document.getElementById("tag-results").innerHTML = `<p style="text-align:center;">Processing...</p>`;

        try {
            const response = await fetch(BACKEND_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ topic: input })
            });

            if (!response.ok) throw new Error("Server error");

            const data = await response.json();

            // ✅ SAVE DESCRIPTION ONCE (MAIN FIX)
            aiDescriptionSnippet = data.description_snippet
                || "This is the first line of your automatically generated SEO description.";

            displayAITitles(data.titles || []);
            displayKeywords(data.keywords || []);
            displayTags(data.tags || []);

            updatePreview(
                "Choose a generated AI title from the list above.",
                aiDescriptionSnippet
            );

        } catch (err) {
            resultsContainer.innerHTML = `<p style="color:red;text-align:center;">
                ❌ Server Connection Failed
            </p>`;
        } finally {
            analyzeButton.disabled = false;
            analyzeButton.textContent = "Analyze & Generate";
        }
    }

    // --- DISPLAY TITLES ---
    function displayAITitles(titles) {
        const container = document.getElementById("titles-results");
        container.innerHTML = "";

        if (!titles.length) {
            container.innerHTML = `<p style="text-align:center;color:yellow;">
                No titles generated.
            </p>`;
            return;
        }

        titles.forEach(title => {
            const div = document.createElement("div");
            div.className = "result-item";

            const span = document.createElement("span");
            span.textContent = title;
            span.style.cursor = "pointer";

            // ✅ ALWAYS USE AI DESCRIPTION
            span.onclick = () => updatePreview(title, aiDescriptionSnippet);

            const btn = document.createElement("button");
            btn.textContent = "Copy";
            btn.onclick = () => {
                navigator.clipboard.writeText(title);
                btn.textContent = "Copied!";
                setTimeout(() => btn.textContent = "Copy", 1500);
            };

            div.appendChild(span);
            div.appendChild(btn);
            container.appendChild(div);
        });
    }

    // --- DISPLAY KEYWORDS ---
    function displayKeywords(data) {
        const container = document.getElementById("keyword-results");
        container.innerHTML = "<h3>Top Keywords & Competition Score</h3>";

        if (!data.length) {
            container.innerHTML += `<p>No keywords found.</p>`;
            return;
        }

        data.forEach(item => {
            const score = Math.max(10, Math.min(100, item.score || 50));
            container.innerHTML += `
                <div class="keyword-item">
                    <div>${item.keyword}</div>
                    <div>${score}/100</div>
                </div>`;
        });
    }

    // --- DISPLAY TAGS ---
    function displayTags(tags) {
        const container = document.getElementById("tag-results");
        container.innerHTML = "<h3>Suggested Tags</h3>";

        if (!tags.length) {
            container.innerHTML += `<p>No tags found.</p>`;
            return;
        }

        tags.forEach(tag => {
            const span = document.createElement("span");
            span.className = "tag-item";
            span.textContent = "#" + tag.toLowerCase().replace(/\s+/g, "_");
            container.appendChild(span);
        });
    }

    // --- PREVIEW UPDATE ---
    function updatePreview(title, description) {
        const shortTitle = title.length > 60 ? title.slice(0, 57) + "..." : title;

        document.getElementById("preview-title").textContent = title;
        document.getElementById("preview-description").textContent = description;

        document.getElementById("desktop-title-overlay").textContent = shortTitle;
        document.getElementById("mobile-title-overlay").textContent = shortTitle;

        document.getElementById("preview-section")
            .scrollIntoView({ behavior: "smooth" });
    }
                    </script>
